# 동시성

## 동시성 문제란

- 여러 작업(프로세스, 스레드, 트랜잭션 등)이 공통 자원에 대해 동시에 접근할 때 발생하는 문제
- 흔히 Database 에서 발생하며 공통 자원에 대한 다수의 수정이 있을때 원하지 않는 결과를 야기 시킨다

## 동시성 제어 기법

### DB 제어기법

- 낙관적 락
  - 조회시가 아닌 수정시점에 데이터 변경 여부를 확인해 제어하는 방식
  - 별도의 lock을 설정하지 않기 때문에 비관적 lock 에 비해 상대적으로 성능이 좋다
- 비관적 락
  - Shared Lock(s-lock)
    - 읽기 잠금
    - 다른 트랙잭션에서 Lock 획득 시도시 Shared Lock 은 가능하나, Exclusive Lock 은 불가능하다
  - Exclusive Lock(x-lock)
    - 쓰기 잠금
    - 다른 트랜잭션에서의 Lock 을 허용하지 않는다.

### 그 외의 제어기법

- Redis 를 이용한 분산락
  - SimpleLock
    - SETNX 를 통해 lock 구현
  - SpinLock
    - SimpleLock 과 기본 동작은 같지만 획득에 실패하면 루프를 돌며 획득할때 까지 혹은 일정 횟수동안 락획득을 시도하는 락
  - 전체 로직 실행 순서 **중요** 락획득 -> 트랜잭션 시작 -> 로직 -> 트랜잭션 종료 -> 락해제
- Kafka 를 이용한 messaging
  - Queue 구조를 이용 처리 순서를 보장

## 프로젝트에서 발생 가능한 부분

- 좌석예약 API
- 잔액충전 API

## 결론

현 프로젝트에는 내가 적용하기에는 DB 제어 기법을 사용하는게 좋다고 생각한다.

왜냐하면, DB 접근 제어 기법에 비해 redis 나 kafka 에 대한 이해도가 부족하다. 

DB 를 통한 제어 기법은 1주차 부터 계속 학습하고 사용하고 있기 때문에 익숙하고 이해도가 상대적으로 높은 상태이다.

그리고, 실무를 진행할 때도 잘 모르는 상태로 개발하고 배포했을때 장애가 발생했다면

잘 모르는 상태이기 때문에 장애 대응이 느리거나 불가능한 상황이 생길 수 있고, 회사에 막대한 피해를 줄 수 있다.

또, 어느정도의 트래픽이 올지 예측이 불가능하다. 그렇다고 아예 동시성에 대한 대비를 안 할 수 없다.

그러면 처음에 동시성을 어떻게 대비할 것인가가 중요한데 그에 대한 나의 트레이드 오프가 DB 를 통한 동시성 제어이다.

DB 를 통한 제어는 구현이 간단하고 애플리케이션 서버의 scale out 을 통해 늘어나는 트래픽에 어느정도 대비도 가능하다.

그러면 두 가지의 DB 제어 락 중 어떤것을 사용하냐가 남았는데, 비관적락을 그 중에서도 Exclusive Lock 을 선택하겠다

낙관적 락의 장점은 성능이 상대적으로 좋다는 것인데, 성능을 고려해야 하는 상황이 오면 redis 나 kafka를 고려하는게 나을거 같다.

먼저 비관적락의 베타락으로 동시성 제어를 해두고 redis 나 kafka 등 학습을 하고 있다가 성능 문제가 생기고 다시 동시성을 고쳐야할 때가 되면

그때 적용하는 것도 나쁘지 않다고 생각한다. 
